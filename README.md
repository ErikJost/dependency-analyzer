# Dependency Analyzer MCP Server

## Overview
This project provides a Dockerized MCP server for dependency analysis, designed for integration with Cursor and other tools. It analyzes project dependencies, generates reports and visualizations, and serves them via a static web server.

## Key Features
- Analyzes code dependencies, orphaned files, and circular dependencies
- Generates detailed reports and interactive visualizations
- All outputs are written to `/data/{project_id}/output`
- Static server serves the `/data` directory at the web root (e.g., `http://localhost:8000/`)
- All report and visualization URLs are of the form `http://{host_ip}:{port}/{project_id}/output/{filename}`
- Fully compatible with Cursor MCP integration and JSON-RPC 2.0

## Directory Structure
- **/data**: Persistent volume for all project outputs and reports
  - **/data/{project_id}/output**: All analysis outputs for a given project
- **scripts/**: All analysis and workflow scripts (Node.js, accept `--output-dir`)
- **sdk_minimal_server.py**: Main MCP server implementation
- **start.sh**: Entrypoint script; starts the static server and MCP server

## Static Server
- The static server is started with:
  ```sh
  python3 -m http.server ${PORT:-8000} --directory /data &
  ```
- This serves all files in `/data` at the web root. For example:
  - `/data/project1/output/enhanced-dependency-visualizer.html` â†’ `http://localhost:8000/project1/output/enhanced-dependency-visualizer.html`

## Output Directory Handling
- **All scripts** accept a `--output-dir=<path>` argument. This controls where all reports and outputs are written.
- The MCP server always passes `/data/{project_id}/output` as the output directory to all scripts.
- All cross-script file references and report links use the resolved output directory.

## MCP Server URL Generation
- The MCP server's `get_web_url_for_output(file_path)` function generates URLs as follows:
  - Computes the relative path from `/data`
  - Uses the current host IP and port (from the `PORT` env var, default 8000)
  - Returns: `http://{host_ip}:{port}/{project_id}/output/{filename}`
- All MCP tool responses and links use this function, ensuring URLs match the static server's structure.

## Example Usage

### Running the MCP Server (Docker)
```sh
docker run -it --rm \
  -v /absolute/path/to/your/projects:/projects \
  -v /absolute/path/to/data:/data \
  -e PORT=8000 \
  -p 8000:8000 \
  mcp/sdk-minimal:latest
```

### Running the Workflow Script
```sh
node scripts/dependency-workflow.cjs --root-dir=/projects/myproject --output-dir=/data/myproject/output
```

### Accessing Results
- Open the visualizer in your browser:
  - `http://localhost:8000/myproject/output/enhanced-dependency-visualizer.html`
- All other reports are available at similar URLs under `/myproject/output/`.

## Integration with Cursor
- The MCP server is configured in Cursor to use Docker and the official image.
- All communication uses JSON-RPC 2.0 and strict request/response patterns.
- The MCP server never sends unsolicited messages and always responds with the correct ID.

## Troubleshooting
- Ensure `/data` is mounted as a Docker volume and is writable.
- All output and report files should appear under `/data/{project_id}/output`.
- If URLs do not work, verify the static server is running and serving `/data` at the correct port.

## Changelog
- All outputs now written to `/data/{project_id}/output`
- Static server serves `/data` at web root
- All URLs generated by MCP are based on the file's relative path from `/data`
- All scripts accept `--output-dir` and propagate it to sub-scripts
- Documentation updated to reflect these changes 

## Output Conventions and Web URLs (May 2024)

- **All output and report files are written to** `/data/<project_id>/` (no `/output/` subfolder).
- **The workflow summary is always** `/data/<project_id>/workflow-summary.md`.
- **The main visualizer is** `/data/<project_id>/enhanced-dependency-visualizer.html`.
- **All web URLs are constructed to match these locations** (e.g., `/project1/enhanced-dependency-visualizer.html`).
- **The server exposes these files via a static web server** on the configured port (default 8000).

### Example JSON Response

```
{
  "success": true,
  "project_id": "project1",
  "output": "...",
  "analysis_path": "/data/project1/analysis_results.json",
  "summary": { ... },
  "summary_url": "http://localhost:8000/project1/workflow-summary.md",
  "visualizer_url": "http://localhost:8000/project1/enhanced-dependency-visualizer.html"
}
```

- The MCP server and all scripts are now **fully commented for maintainability**.

For more details, see comments in `src/sdk_minimal_server.py` and the workflow scripts. 

## Scripts Overview

This project includes a set of Node.js scripts in the `scripts/` directory that together provide a comprehensive dependency and orphaned file analysis workflow. All scripts accept a `--output-dir=<path>` argument to control where reports and outputs are written.

| Script | Description |
|--------|-------------|
| **analyze-dependencies.cjs** | Analyzes the project's dependency graph by scanning import statements. Identifies potentially orphaned files (not imported by any other file) and generates a report. |
| **enhanced-dependency-analysis.cjs** | Performs a deeper analysis, handling barrel files (index.ts/js), re-exports, and route-based component references. Generates enhanced orphaned file and dependency graph reports. |
| **analyze-build-dependencies.cjs** | Analyzes the build log to determine which potentially orphaned files are actually used during the build process. Updates the orphaned files list accordingly. |
| **update-orphaned-files-report.cjs** | Updates the orphaned files report by removing files that are confirmed as used during the build. Produces a 'confirmed orphaned files' report. |
| **check-dynamic-imports.cjs** | Scans for dynamic imports, React.lazy, and other patterns that may reference files not detected by static analysis. Helps identify false positives in the orphaned files list. |
| **verify-route-components.cjs** | Analyzes React route definitions to find components that may be referenced dynamically in routes, further refining the orphaned files list. |
| **dependency-workflow.cjs** | Orchestrates the full workflow: runs all analysis scripts in sequence, generates all reports, and (optionally) archives confirmed orphaned files. Produces a workflow summary and links to visualizations. |
| **batch-archive-orphaned.cjs** | Reads the final orphaned files report and archives each file using the archive script. Generates a report of the archival process. |
| **archive-orphaned-file.cjs** | Moves a specified orphaned file to the archive directory (never deletes). Updates the cleanup checklist. |

**Special Notes:**
- The refined analysis and confidence/impact ratings in some reports are for human review only and do not affect which files are archived or reported as orphaned.
- All scripts are fully commented for maintainability and clarity.
- The workflow is designed to be safe: no files are deleted, only moved to an archive directory.

For more details, see comments in each script in the `scripts/` directory. 

## Docker Image Usage (Updated)

This project uses a single, official Docker image for all MCP server deployments:

- **Image name:** `mcp/sdk-minimal:latest`
- **Dockerfile:** `src/Dockerfile.sdk_minimal`

### Building the Image

To build the image, always use:

```bash
docker build -t mcp/sdk-minimal:latest -f src/Dockerfile.sdk_minimal .
```

- Do **not** attach any data volumes during the build step.
- The build step is for image creation only.

### Running the Container

To run the MCP server with persistent data and project access:

```bash
docker run -d --name DependencyMCP \
  -v /Users/erikjost/data:/data \
  -v /Users/erikjost:/Users/erikjost \
  -p 8000:8000 \
  mcp/sdk-minimal:latest
```

- `/Users/erikjost/data` is a host directory for persistent analysis data.
- `/Users/erikjost` is your user/project directory, making all projects accessible inside the container.
- Adjust paths as needed for your environment.

### Cursor Integration

For Cursor, use this configuration in `~/.cursor/mcp.json`:

```json
{
  "mcpServers": {
    "dependencyAnalyzer": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "-v",
        "/Users/erikjost/data:/data",
        "-v",
        "/Users/erikjost:/Users/erikjost",
        "mcp/sdk-minimal:latest"
      ]
    }
  }
}
```

### Best Practices

- Always stop and remove old containers before starting a new one:
  ```bash
  docker stop DependencyMCP || true
  docker rm DependencyMCP || true
  ```
- Never attach data volumes during the build step.
- Only use `mcp/sdk-minimal:latest` for all MCP server deployments.
- See the README and `docker-image-hygiene.md` for more details and troubleshooting. 